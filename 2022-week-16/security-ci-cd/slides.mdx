import { themes } from 'mdx-deck'

export const theme = themes.swiss;

# Security tooling for your CI/CD

[Nikita Barskov] @ Coop Norge, 2022

[Nikita Barskov]:  https://github.com/nikitabarskov

---

## What do we have so far?

Every organisation wants to have a secure Software Development Life Cycle.
Application we are building and designing are complex. We want to have security
checks as early as possible.

For example supply chain of dependencies even for a small simple
applications
can rapidly grow: OS-specific packages, language-specific packages,
infrastructure configurations.

You can check more at:

- [Secure Software Development Life Cycle]

[Secure Software Development Life Cycle]: https://snyk.io/learn/secure-sdlc/

---

## Approaching the problem

There is no HOW-TO guide for security as usual, but [DevSecOps] is a journey
to build security into the Continuous Delivery of software as part of the
DevOps process.

Check more at:

- [DevSecOps Model]
- [Continuous Security within DevSecOps]

[DevSecOps]:  https://github.com/devsecops/devsecops/blob/master/01_What_is_DevSecOps.md
[DevSecOps Model]: https://snyk.io/series/devsecops/
[Continuous Security within DevSecOps]: https://snyk.io/learn/what-is-ci-cd-pipeline-and-tools-explained/continuous-security/

---

## Supply chain security tooling

Bringing security scanning early stages of the development tends to have
appropriate tooling.

I will cover today these OSS instruments to scan and detect vulnerabilities
and misconfiguration in your code and configurations:

- [anchore/syft]
- [anchore/grype]
- [aquasecurity/trivy]

[anchore/syft]:  https://github.com/anchore/syft
[anchore/grype]:  https://github.com/anchore/grype
[aquasecurity/trivy]:  https://github.com/aquasecurity/trivy

---

## What is a Software Bill of Materials?

> A SBOM is a nested inventory, a list of ingredients that make up software
components. [CISA]

SBOMs adds security to the software supply chain in the following ways:

- greater visibility across the software product, including system
  relationships;
- information sharing about vulnerabilities;
- better communication across the supply chain, from developer to user, making
  it easier to identify security risks;
- in-depth records of compliance standards and audits.

[CISA]: https://www.cisa.gov/sbom

---

## How does SBOM look like?

Boring. But if you are curious check [Syft SBOM JSON Schema].

But what is more important, there are tools allow us to generate these SBOMs.
And Syft is one of them.

[Syft SBOM JSON Schema]: https://github.com/anchore/syft/tree/main/schema/json

---

## Syft

A CLI tool and Go library for generating a Software Bill of Materials (SBOM)
from container images and filesystems.

### Supported ecosystems

Alpine (apk), Dart (pubs), Debian (dpkg),
Go (go.mod, Go binaries), Java (jar, ear, war, par, sar),
JavaScript (npm, yarn), Jenkins Plugins (jpi, hpi),
PHP (composer), Python (wheel, egg, poetry, requirements.txt),
Red Hat (rpm), Ruby (gem), Rust (cargo.lock).

---

## Syft Usage

###  For image:

```shell
syft docker:docker.io/library/python:3.10
```

### For image tarball:

```shell
syft docker-archive:my-awesome-image.tar
```

### For filesystem:

```shell
syft dir:.
```

---

## Grype

A vulnerability scanner for container images and filesystems.

### Supported ecosystems

#### Language-specific packages

Ruby (Gems), Java (JAR, WAR, EAR, JPI, HPI),
JavaScript (NPM, Yarn), Python (Egg, Wheel, Poetry, requirements.txt/setup.py).

#### OS-specific packages

Alpine, Amazon Linux, BusyBox, CentOS, Debian, Distroless,
Oracle Linux, Red Hat (RHEL), Ubuntu.

#### Images

Docker and OCI

---

## Grype usage

For a given SBOM generated by

```shell
syft docker-archive:my-awesome-image.tar --file my-awesome-image.syft.json
```

we can run

```shell
grype sbom:my-awesome-image.syft.json --file my-awesome-image.sarif
```

and get security report in [SARIF] format.

[SARIF]: https://sarifweb.azurewebsites.net/

---

## What is the SARIF?

The Static Analysis Results Interchange Format (SARIF)
is an industry standard format for the output of static analysis tools.

---

## Trivy

Trivy is a simple and comprehensive vulnerability scanner for containers
and other artifacts.

### Supported ecosystems

#### OS-specific packages

Alpine, Red Hat Universal Base Image, Red Hat Enterprise Linux, CentOS,
Oracle Linux, Debian, Ubuntu, Amazon Linux, openSUSE Leap,
SUSE Enterprise Linux, Photon OS and Distroless.

Full list of supported [trivy OS-specific packages].

[trivy OS-specific packages]:https://aquasecurity.github.io/trivy/v0.26.0/docs/vulnerability/detection/os/

#### Language-specific packages

Bundler, Composer, Pipenv, Poetry, npm, yarn, Cargo, NuGet, Maven, and Go

Full list of supported [trivy language-specific packages].

[trivy language-specific packages]: https://aquasecurity.github.io/trivy/v0.26.0/docs/vulnerability/detection/language/

---

## Misconfiguration support in Trivy

Trivy provides built-in policies to detect configuration issues in Docker,
Kubernetes and Terraform.

---

## Implementation in Place

I took [coop-playbook] as a trial repository to test security checks.

We build a docker image for our coop-playbook deployment and use NPM and Python
dependencies, so this repo is an ideal candidate.

[coop-playbook]: https://github.com/coopnorge/coop-playbook

---

## Let's create tarball to run trivy and syft/grype

We need to build and export the image as a tarball in order to run
vulnerability checks for container image:

```makefile
coop-playbook.tar:
	$(docker) buildx build $(buildx_args) \
		--file Dockerfile \
		--target app \
		--tag $(IMAGE) \
		.
	$(docker) image save \
		--output coop-playbook.tar \
		ocreg.localhost/coop-playbook
```

---

## Let's try to run trivy

We need to run trivy

```makefile
check-security-trivy: coop-playbook.tar  ## Run trivy security check
	$(docker_compose_run) trivy image \
		--input coop-playbook.tar \
		--format=sarif \
		--output=coop-playbook.trivy.sarif
	$(docker_compose_run) trivy fs \
		--format=sarif \
		--output=misconfiguration-and-vulnerabilities.trivy.sarif \
		.
```

---

## And put it in GitHub Actions CI

```yaml
  - uses: actions/checkout@v2
    with:
      fetch-depth: 0
  - run: |
      make check-security-trivy \
        buildx_args="--cache-from type=gha --cache-to type=gha,mode=max"
  - uses: github/codeql-action/upload-sarif@v1
    with:
      category: trivy-image-sarif
      sarif_file: "coop-playbook.trivy.sarif"
  - uses: github/codeql-action/upload-sarif@v1
    with:
      category: trivy-misconfiguration-and-vulnerabilities-sarif
      sarif_file: "misconfiguration-and-vulnerabilities.trivy.sarif"
```

---

## Let's do the same for syft/grype

```makefile
coop-playbook.syft.json: coop-playbook.tar
	$(docker_compose_run) syft docker-archive:coop-playbook.tar \
        --file coop-playbook.syft.json

dependencies.syft.json:
	$(docker_compose_run) syft dir:. \
        --file dependencies.syft.json

check-security-grype: coop-playbook.syft.json dependencies.syft.json  ## Run grype security check
	$(docker_compose_run) grype sbom:coop-playbook.syft.json \
        --file coop-playbook.sarif
	$(docker_compose_run) grype sbom:dependencies.syft.json \
        --file dependencies.sarif
```

---

## And put it into GitHub Actions too

```yaml
  - uses: actions/checkout@v2
    with:
      fetch-depth: 0
  - run: |
      make check-security-grype \
        buildx_args="--cache-from type=gha --cache-to type=gha,mode=max"
  - uses: github/codeql-action/upload-sarif@v1
    with:
      category: grype-image-sarif
      sarif_file: 'coop-playbook.sarif'
  - uses: github/codeql-action/upload-sarif@v1
    with:
      category: grype-dependencies-sarif
      sarif_file: 'dependencies.sarif'
```

---

## It even reports in your PR:

<img src="./pr.png"  alt={"PR"}/>

---

## with details as for grype...

<img src="./grype.png"  alt={"PR"}/>

---

## as for trivy

<img src="./trivy.png"  alt={"PR"}/>

---

<img src="./pepe.jpeg"  alt={"PR"}/>

---

# QA

---

# Made with ❤️ @ Coop Norge
